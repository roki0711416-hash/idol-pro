<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レッスン</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <main class="page">
    <div class="wrap">
      <div class="topbar" aria-label="ヘッダー">
        <div>
          <div style="font-weight: 900; font-size: 18px; letter-spacing: 0.02em;">レッスン</div>
          <a class="linkrow" id="back-link" href="./dashboard.html">← ダッシュボードへ戻る</a>
          <span style="display:inline-block; width: 10px;"></span>
          <a class="linkrow" href="./gacha.html">▶ ガチャへ</a>
        </div>
        <div class="topbar-right">
          <div class="wallet" aria-label="所持通貨">
            <span>coins</span> <strong id="coins">-</strong>
            <span>gems</span> <strong id="gems">-</strong>
            <span>残りライブチケット</span> <strong id="tickets">-</strong>
            <span>hype</span> <strong id="hype">-</strong>
          </div>
          <a class="user" href="#" aria-label="ユーザー">
            <span class="avatar" aria-hidden="true">U</span>
            <span>ユーザー</span>
          </a>
        </div>
      </div>

      <section class="card" aria-label="対象アイドル">
        <h1 class="h1" id="idol-name">レッスン</h1>
        <p class="subtext">無制限で実行できます（スタミナ制はありません）。</p>
      </section>

      <section class="card" aria-label="ステータス">
        <div class="two-col">
          <div class="profile">
            <p class="smalltitle">現在の状態</p>

            <div class="profilelist">
              <div class="row">
                <div class="k">ファン数</div>
                <div class="v" id="fans">-</div>
              </div>
            </div>

            <p class="smalltitle" style="margin-top: 6px;">ステータス</p>
            <div class="stats" aria-label="ステータスバー">
              <div class="stat">
                <div class="stathead">
                  <div class="statname">vocal</div>
                  <div class="statval" id="vocal-text">-</div>
                </div>
                <div class="bar"><div class="fill" id="vocal-fill" style="width: 0%;"></div></div>
              </div>
              <div class="stat">
                <div class="stathead">
                  <div class="statname">dance</div>
                  <div class="statval" id="dance-text">-</div>
                </div>
                <div class="bar"><div class="fill" id="dance-fill" style="width: 0%;"></div></div>
              </div>
              <div class="stat">
                <div class="stathead">
                  <div class="statname">expression</div>
                  <div class="statval" id="expression-text">-</div>
                </div>
                <div class="bar"><div class="fill" id="expression-fill" style="width: 0%;"></div></div>
              </div>
            </div>
          </div>

          <div class="actions" aria-label="レッスン">
            <p class="smalltitle">レッスン</p>
            <button class="btn btn-primary" id="lesson-vocal" type="button">(A) ボーカルレッスン</button>
            <button class="btn btn-primary" id="lesson-dance" type="button">(B) ダンスレッスン</button>
            <button class="btn btn-primary" id="lesson-expression" type="button">(C) 表現力レッスン</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="./game.js"></script>
  <script>
    (function () {
      function qs(id) { return document.getElementById(id); }
      function fmtNumber(n) {
        try { return new Intl.NumberFormat('ja-JP').format(n); } catch (e) { return String(n); }
      }
      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }
      function statToPercent(value) {
        return clamp(value, 0, 100);
      }

      var role = localStorage.getItem('idol-pro:role');
      if (role !== 'producer') {
        window.location.replace('./index.html');
        return;
      }

      var backLink = qs('back-link');
      backLink.href = './dashboard.html';

      function renderHeader() {
        var w = window.IdolProGame.loadWallet();
        var d = window.IdolProGame.loadDaily();
        qs('coins').textContent = fmtNumber(w.coins);
        qs('gems').textContent = fmtNumber(w.gems);
        qs('tickets').textContent = String(d.liveTickets);
        qs('hype').textContent = String(d.hype) + ' (' + String(d.snsPowerUsed) + '/3)';
      }

      function showToast(message) {
        var el = qs('toast');
        el.textContent = message;
        el.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          el.classList.remove('show');
        }, 1600);
      }


      function render() {
        var s = window.IdolProGame.loadStats();

        qs('fans').textContent = fmtNumber(s.fans);
        qs('vocal-text').textContent = String(s.vocal);
        qs('dance-text').textContent = String(s.dance);
        qs('expression-text').textContent = String(s.expression);

        qs('vocal-fill').style.width = statToPercent(s.vocal) + '%';
        qs('dance-fill').style.width = statToPercent(s.dance) + '%';
        qs('expression-fill').style.width = statToPercent(s.expression) + '%';

        document.title = 'レッスン';
        renderHeader();
      }

      function onLesson(typeLabel, typeKey) {
        var result = window.IdolProGame.applyLesson(typeKey);
        if (!result.ok) {
          showToast('実行できません');
          render();
          return;
        }

        render();
        showToast(typeLabel + ' +' + result.delta.stat + ' / ファン +' + result.delta.fans + ' / coins +' + result.delta.coins);
      }

      qs('lesson-vocal').addEventListener('click', function () {
        onLesson('vocal', 'vocal');
      });
      qs('lesson-dance').addEventListener('click', function () {
        onLesson('dance', 'dance');
      });
      qs('lesson-expression').addEventListener('click', function () {
        onLesson('expression', 'expression');
      });

      window.addEventListener('storage', function (e) {
        if (!e.key) return;
        if (e.key === window.IdolProGame.WALLET_KEY ||
            e.key === window.IdolProGame.DAILY_KEY ||
            e.key === window.IdolProGame.STATS_KEY) {
          render();
        }
      });

      render();
    })();
  </script>
</body>
</html>
