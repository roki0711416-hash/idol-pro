<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>育成</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <main class="page">
    <div class="wrap container-narrow">
      <div class="topbar" aria-label="ヘッダー">
        <div>
          <div class="brand">育成</div>
          <a class="linkrow" id="back-link" href="./dashboard.html">← 戻る</a>
        </div>
        <div class="topbar-right">
          <div class="wallet" aria-label="所持">
            <span>コイン</span> <strong id="coins">-</strong>
            <span>ファン</span> <strong id="fans">-</strong>
            <span>ジェム</span> <strong id="gems">-</strong>
          </div>
        </div>
      </div>

      <section class="card" aria-label="現在アイドル">
        <h1 class="h1" id="idol-name">-</h1>
        <p class="subtext">
          <span>Lv </span><strong id="idol-level">-</strong>
          <span style="display:inline-block; width: 10px;"></span>
          <span>経験値 </span><strong id="idol-exp">-</strong><span>/100</span>
        </p>
        <div class="training-stats" aria-label="ステータス">
          <div class="training-stat"><span class="k">歌</span><strong class="v" id="vocal">-</strong></div>
          <div class="training-stat"><span class="k">ダンス</span><strong class="v" id="dance">-</strong></div>
          <div class="training-stat"><span class="k">表現</span><strong class="v" id="expression">-</strong></div>
        </div>
      </section>

      <section class="card" aria-label="育成メニュー">
        <p class="smalltitle">基本</p>
        <div class="btn-grid" role="group" aria-label="基本メニュー">
          <button class="btn btn-secondary" data-menu="basic_vocal" type="button">歌</button>
          <button class="btn btn-secondary" data-menu="basic_dance" type="button">ダンス</button>
          <button class="btn btn-secondary" data-menu="basic_expression" type="button">表現</button>
        </div>

        <p class="smalltitle" style="margin-top: 12px;">強化</p>
        <div class="btn-grid" role="group" aria-label="強化メニュー">
          <button class="btn btn-primary" data-menu="hard_vocal" type="button">歌</button>
          <button class="btn btn-primary" data-menu="hard_dance" type="button">ダンス</button>
          <button class="btn btn-primary" data-menu="hard_expression" type="button">表現</button>
        </div>
      </section>

      <section class="card" aria-label="結果ログ">
        <p class="smalltitle">結果ログ（最新10件）</p>
        <ol class="loglist" id="log"></ol>
      </section>
    </div>
  </main>

  <script src="./game.js"></script>
  <script>
    (function () {
      function qs(id) { return document.getElementById(id); }
      function fmtNumber(n) {
        try { return new Intl.NumberFormat('ja-JP').format(n); } catch (e) { return String(n); }
      }

      var role = localStorage.getItem('idol-pro:role');
      if (role && role !== 'producer') {
        window.location.replace('./index.html');
        return;
      }

      var logs = [];

      function pushLog(message) {
        logs.unshift(String(message || ''));
        logs = logs.slice(0, 10);
      }

      function render() {
        var state = window.IdolProGame.getState();
        var idol = window.IdolProGame.getCurrentIdol();

        qs('coins').textContent = fmtNumber(state.coins);
        qs('fans').textContent = fmtNumber(state.fans);
        qs('gems').textContent = fmtNumber(state.gems);

        qs('idol-name').textContent = idol.name;
        qs('idol-level').textContent = String(idol.level);
        qs('idol-exp').textContent = String(idol.exp);
        qs('vocal').textContent = String(idol.stats.vocal);
        qs('dance').textContent = String(idol.stats.dance);
        qs('expression').textContent = String(idol.stats.expression);

        var logEl = qs('log');
        logEl.innerHTML = '';
        for (var i = 0; i < logs.length; i++) {
          var li = document.createElement('li');
          li.textContent = logs[i];
          logEl.appendChild(li);
        }
      }

      function onClickMenu(menuKey) {
        var result = window.IdolProGame.applyTraining(menuKey);
        pushLog(result.message);
        render();
      }

      var buttons = document.querySelectorAll('[data-menu]');
      for (var i = 0; i < buttons.length; i++) {
        (function (btn) {
          btn.addEventListener('click', function () {
            onClickMenu(btn.getAttribute('data-menu'));
          });
        })(buttons[i]);
      }

      window.addEventListener('storage', function (e) {
        if (!e.key) return;
        if (e.key === window.IdolProGame.STATE_KEY) render();
      });

      render();
    })();
  </script>
</body>
</html>
