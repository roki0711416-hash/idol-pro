<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>プラン / 衣装</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <main class="page">
    <div class="wrap">
      <div class="topbar" aria-label="ヘッダー">
        <div>
          <div style="font-weight: 900; font-size: 18px; letter-spacing: 0.02em;">プラン / 衣装</div>
          <a class="linkrow" href="./dashboard.html">← ダッシュボードへ戻る</a>
        </div>
        <div class="topbar-right">
          <div class="wallet" aria-label="所持通貨">
            <span>coins</span> <strong id="coins">-</strong>
            <span>gems</span> <strong id="gems">-</strong>
            <span>残りライブチケット</span> <strong id="tickets">-</strong>
            <span>hype</span> <strong id="hype">-</strong>
            <span>plan</span> <strong id="plan">-</strong>
          </div>
          <a class="user" href="#" aria-label="ユーザー">
            <span class="avatar" aria-hidden="true">U</span>
            <span>ユーザー</span>
          </a>
        </div>
      </div>

      <section class="card" aria-label="プラン">
        <h1 class="h1">プラン</h1>
        <p class="subtext">衣装の利用可否は「無料」または「サブスクリプション」で決まります。ランダム排出や確率表示はありません。</p>

        <div style="height: 14px;"></div>

        <div class="grid" aria-label="プラン選択">
          <div class="tile">
            <div class="idol-head">
              <h2 class="idol-name">無料プラン</h2>
              <span class="badge" id="badge-free" style="display:none;">現在</span>
            </div>
            <p>初期衣装（制限付き） のみ使用可能</p>
            <div style="height: 10px;"></div>
            <button class="btn btn-secondary" id="set-free" type="button">無料で続ける</button>
            <p class="subtext">※ 購入強制はしません</p>
          </div>

          <div class="tile">
            <div class="idol-head">
              <h2 class="idol-name">ベーシック（月額）</h2>
              <span class="badge" id="badge-basic" style="display:none;">現在</span>
            </div>
            <p>衣装バリエーション：少 / 基本機能のみ</p>
            <div style="height: 10px;"></div>
            <button class="btn btn-primary" id="set-basic" type="button">ベーシックにする</button>
            <p class="subtext">※ 決済はデモ（状態フラグのみ）</p>
          </div>

          <div class="tile">
            <div class="idol-head">
              <h2 class="idol-name">プレミアム（月額）</h2>
              <span class="badge" id="badge-premium" style="display:none;">現在</span>
            </div>
            <p>衣装バリエーション：多 / 特典機能を解放</p>
            <div style="height: 10px;"></div>
            <button class="btn btn-primary" id="set-premium" type="button">プレミアムにする</button>
            <p class="subtext">※ 購入強制はしません</p>
          </div>
        </div>
      </section>

      <section class="card" aria-label="衣装一覧">
        <p class="smalltitle">衣装一覧</p>
        <div class="idol-grid" id="costume-list" aria-label="衣装一覧"></div>
      </section>
    </div>
  </main>

  <script src="./game.js"></script>
  <script>
    (function () {
      function qs(id) { return document.getElementById(id); }
      function fmtNumber(n) {
        try { return new Intl.NumberFormat('ja-JP').format(n); } catch (e) { return String(n); }
      }
      function showToast(message) {
        var el = qs('toast');
        el.textContent = message;
        el.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          el.classList.remove('show');
        }, 1700);
      }

      function planLabel(plan) {
        if (plan === 'premium') return 'PREMIUM';
        if (plan === 'basic') return 'BASIC';
        return 'FREE';
      }

      var role = localStorage.getItem('idol-pro:role');
      if (role !== 'producer') {
        window.location.replace('./index.html');
        return;
      }

      var listEl = qs('costume-list');

      function renderHeader() {
        var w = window.IdolProGame.loadWallet();
        qs('coins').textContent = fmtNumber(w.coins);
        qs('gems').textContent = fmtNumber(w.gems);

        var d = window.IdolProGame.loadDaily();
        qs('tickets').textContent = String(d.liveTickets);
        qs('hype').textContent = String(d.hype) + ' (' + String(d.snsPowerUsed) + '/3)';

        var plan = window.IdolProGame.getSubscriptionPlan();
        qs('plan').textContent = planLabel(plan);
      }

      function renderPlanBadges() {
        var plan = window.IdolProGame.getSubscriptionPlan();
        qs('badge-free').style.display = plan === 'free' ? 'inline-flex' : 'none';
        qs('badge-basic').style.display = plan === 'basic' ? 'inline-flex' : 'none';
        qs('badge-premium').style.display = plan === 'premium' ? 'inline-flex' : 'none';
      }

      function costumeBonusText(c) {
        var b = (c && c.bonus) ? c.bonus : {};
        var parts = [];
        if (b.fansPct) parts.push('fans +' + Math.round(b.fansPct * 100) + '%');
        if (b.liveSuccessPct) parts.push('live +' + Math.round(b.liveSuccessPct * 100) + '%');
        if (Number.isFinite(b.score) && b.score) parts.push('score +' + String(b.score));
        return parts.length ? parts.join(' / ') : 'bonus なし';
      }

      function requiredPlanLabel(p) {
        if (p === 'premium') return 'プレミアム';
        if (p === 'basic') return 'ベーシック';
        return '無料';
      }

      function renderCostumeList() {
        var catalog = window.IdolProGame.getCostumeCatalog();
        listEl.innerHTML = '';
        for (var i = 0; i < catalog.length; i++) {
          var row = catalog[i];
          var c = row.costume;
          var a = document.createElement('div');
          a.className = 'tile';
          a.innerHTML =
            '<div class="idol-head">' +
              '<h2 class="idol-name">' + c.name + '</h2>' +
              '<span class="badge">' + c.rarity + '</span>' +
            '</div>' +
            '<p>必要プラン: ' + requiredPlanLabel(row.requiredPlan) + (row.available ? '' : '（未契約）') + '</p>' +
            '<p class="subtext">' + costumeBonusText(c) + '</p>';
          listEl.appendChild(a);
        }
      }

      function setPlan(plan) {
        window.IdolProGame.setSubscriptionPlan(plan);
        renderHeader();
        renderPlanBadges();
        renderCostumeList();
        showToast('プランを更新しました');
      }

      qs('set-free').addEventListener('click', function () { setPlan('free'); });
      qs('set-basic').addEventListener('click', function () { setPlan('basic'); });
      qs('set-premium').addEventListener('click', function () { setPlan('premium'); });

      window.addEventListener('storage', function (e) {
        if (!e.key) return;
        if (e.key === window.IdolProGame.WALLET_KEY || e.key === window.IdolProGame.DAILY_KEY || e.key === window.IdolProGame.SUBSCRIPTION_KEY) {
          renderHeader();
          renderPlanBadges();
          renderCostumeList();
        }
      });

      renderHeader();
      renderPlanBadges();
      renderCostumeList();
    })();
  </script>
</body>
</html>
