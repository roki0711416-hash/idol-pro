<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ガチャ</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <main class="page">
    <div class="wrap">
      <div class="topbar" aria-label="ヘッダー">
        <div>
          <div style="font-weight: 900; font-size: 18px; letter-spacing: 0.02em;">ガチャ</div>
          <a class="linkrow" href="./dashboard.html">← ダッシュボードへ戻る</a>
        </div>
        <div class="topbar-right">
          <div class="wallet" aria-label="所持通貨">
            <span>coins</span> <strong id="coins">-</strong>
            <span>gems</span> <strong id="gems">-</strong>
            <span>残りライブチケット</span> <strong id="tickets">-</strong>
            <span>hype</span> <strong id="hype">-</strong>
          </div>
          <a class="user" href="#" aria-label="ユーザー">
            <span class="avatar" aria-hidden="true">U</span>
            <span>ユーザー</span>
          </a>
        </div>
      </div>

      <section class="card" aria-label="ガチャメニュー">
        <h1 class="h1">衣装ガチャ</h1>
        <p class="subtext">コイン/ジェムで衣装を獲得します（天井：50でSSR確定）。</p>

        <div style="height: 14px;"></div>

        <div class="grid" aria-label="ガチャ種類">
          <div class="tile">
            <div class="idol-head">
              <h2 class="idol-name">コインガチャ</h2>
              <span class="badge" id="pity-coin">pity -</span>
            </div>
            <p>1回 200 coins / 10連 1800 coins</p>
            <div style="height: 10px;"></div>
            <button class="btn btn-primary" id="coin-1" type="button">コインで1回</button>
            <button class="btn btn-secondary" id="coin-10" type="button">コインで10連</button>
          </div>

          <div class="tile">
            <div class="idol-head">
              <h2 class="idol-name">ジェムガチャ</h2>
              <span class="badge" id="pity-gem">pity -</span>
            </div>
            <p>1回 100 gems / 10連 900 gems</p>
            <div style="height: 10px;"></div>
            <button class="btn btn-primary" id="gem-1" type="button">ジェムで1回</button>
            <button class="btn btn-secondary" id="gem-10" type="button">ジェムで10連</button>
            <p class="subtext">※ gemsが不足している場合は引けません（ダミー通貨）。</p>
          </div>

          <div class="tile">
            <h2 class="idol-name">排出率</h2>
            <p>COMMON 60% / RARE 30% / SR 9% / SSR 1%</p>
            <div style="height: 10px;"></div>
            <p class="subtext">ボーナス例: ファン+5% / ライブ成功+2%</p>
          </div>
        </div>
      </section>

      <section class="card" aria-label="結果">
        <p class="smalltitle">結果</p>
        <div class="idol-grid" id="results" aria-label="ガチャ結果"></div>
      </section>
    </div>
  </main>

  <script src="./game.js"></script>
  <script>
    (function () {
      function qs(id) { return document.getElementById(id); }
      function fmtNumber(n) {
        try { return new Intl.NumberFormat('ja-JP').format(n); } catch (e) { return String(n); }
      }
      function showToast(message) {
        var el = qs('toast');
        el.textContent = message;
        el.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          el.classList.remove('show');
        }, 1700);
      }

      var role = localStorage.getItem('idol-pro:role');
      if (role !== 'producer') {
        window.location.replace('./index.html');
        return;
      }

      var resultsEl = qs('results');

      function renderWalletAndPity() {
        var w = window.IdolProGame.loadWallet();
        qs('coins').textContent = fmtNumber(w.coins);
        qs('gems').textContent = fmtNumber(w.gems);

        var d = window.IdolProGame.loadDaily();
        qs('tickets').textContent = String(d.liveTickets);
        qs('hype').textContent = String(d.hype) + ' (' + String(d.snsPowerUsed) + '/3)';

        var game = window.IdolProGame.loadGameState();
        qs('pity-coin').textContent = 'pity ' + String(game.pity.coin) + ' / 50';
        qs('pity-gem').textContent = 'pity ' + String(game.pity.gem) + ' / 50';
      }

      function costumeBonusText(c) {
        var b = (c && c.bonus) ? c.bonus : {};
        var parts = [];
        if (b.fansPct) parts.push('fans +' + Math.round(b.fansPct * 100) + '%');
        if (b.liveSuccessPct) parts.push('live +' + Math.round(b.liveSuccessPct * 100) + '%');
        return parts.length ? parts.join(' / ') : 'bonus なし';
      }

      function renderResults(costumes) {
        resultsEl.innerHTML = '';
        for (var i = 0; i < costumes.length; i++) {
          var c = costumes[i];
          var a = document.createElement('div');
          a.className = 'tile';
          a.innerHTML =
            '<div class="idol-head">' +
              '<h2 class="idol-name">' + c.name + '</h2>' +
              '<span class="badge">' + c.rarity + '</span>' +
            '</div>' +
            '<p>ID: ' + c.id + '</p>' +
            '<p class="subtext">' + costumeBonusText(c) + '</p>';
          resultsEl.appendChild(a);
        }
      }

      function doGacha(currency, count) {
        var result = window.IdolProGame.rollGacha(currency, count);
        if (!result.ok) {
          if (result.reason === 'not-enough') {
            showToast('通貨が足りません');
          } else {
            showToast('引けません');
          }
          renderWalletAndPity();
          return;
        }

        renderWalletAndPity();
        renderResults(result.results);
        showToast('獲得: ' + result.results.length + '件');
      }

      qs('coin-1').addEventListener('click', function () { doGacha('coin', 1); });
      qs('coin-10').addEventListener('click', function () { doGacha('coin', 10); });
      qs('gem-1').addEventListener('click', function () { doGacha('gem', 1); });
      qs('gem-10').addEventListener('click', function () { doGacha('gem', 10); });

      window.addEventListener('storage', function (e) {
        if (!e.key) return;
        if (e.key === window.IdolProGame.WALLET_KEY || e.key === window.IdolProGame.GAME_KEY || e.key === window.IdolProGame.DAILY_KEY) {
          renderWalletAndPity();
        }
      });

      renderWalletAndPity();
    })();
  </script>
</body>
</html>
